<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <div class="controls">
    <p>クリック: 花火を打ち上げ</p>
    <p>自動打ち上げ: <span id="autoStatus">OFF</span></p>
    <button id="toggleAuto">自動打ち上げ ON/OFF</button>
  </div>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>99: リアルな花火</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      overflow: hidden;
      font-family: sans-serif;
    }

    canvas {
      display: block;
      background: linear-gradient(to bottom, #000428, #004e92);
    }

    .controls {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 8px;
      z-index: 10;
    }

    .controls h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }

    .controls p {
      margin: 5px 0;
      font-size: 14px;
    }

    button {
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #ff6b6b;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #ff5252;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>

  <script>
    const canvas = document.getElementById("canvas")
    const ctx = canvas.getContext("2d")

    // キャンバスサイズを画面全体に
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight

    // 画面サイズ変更時の対応
    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth
      canvas.height = window.innerHeight
    })

    // 色パレット
    const colorPalettes = [
      ["#ff0000", "#ff4444", "#ff8888", "#ffaaaa"], // 赤
      ["#00ff00", "#44ff44", "#88ff88", "#aaffaa"], // 緑
      ["#0000ff", "#4444ff", "#8888ff", "#aaaaff"], // 青
      ["#ffff00", "#ffff44", "#ffff88", "#ffffaa"], // 黄
      ["#ff00ff", "#ff44ff", "#ff88ff", "#ffaaff"], // マゼンタ
      ["#00ffff", "#44ffff", "#88ffff", "#aaffff"], // シアン
      ["#ff8800", "#ffaa00", "#ffcc44", "#ffee88"], // オレンジ
    ]

    let rockets = [] // 打ち上げ中のロケット
    let particles = [] // 爆発した粒子
    let autoLaunch = false // 自動打ち上げモード

    // パーティクル（花火の粒）クラス
    class Particle {
      constructor(x, y, color) {
        this.x = x
        this.y = y
        this.color = color

        // ランダムな方向と速度
        const angle = Math.random() * Math.PI * 2
        const speed = Math.random() * 5 + 2
        this.vx = Math.cos(angle) * speed
        this.vy = Math.sin(angle) * speed

        // 重力と抵抗
        this.gravity = 0.05
        this.friction = 0.98

        // 見た目
        this.alpha = 1
        this.size = Math.random() * 2 + 1

        // 軌跡
        this.trail = []
        this.trailLength = 5
      }

      update() {
        // 軌跡を記録
        this.trail.push({ x: this.x, y: this.y })
        if (this.trail.length > this.trailLength) {
          this.trail.shift()
        }

        // 速度を更新
        this.vy += this.gravity
        this.vx *= this.friction
        this.vy *= this.friction

        // 位置を更新
        this.x += this.vx
        this.y += this.vy

        // 徐々に消える
        this.alpha -= 0.01
      }

      draw() {
        // 軌跡を描く
        if (this.trail.length > 1) {
          for (let i = 0; i < this.trail.length - 1; i++) {
            const t = this.trail[i]
            const alpha = (i / this.trail.length) * this.alpha

            ctx.beginPath()
            ctx.arc(t.x, t.y, this.size * 0.5, 0, Math.PI * 2)
            ctx.fillStyle = this.color
            ctx.globalAlpha = alpha * 0.5
            ctx.fill()
          }
        }

        // パーティクル本体
        ctx.beginPath()
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2)
        ctx.fillStyle = this.color
        ctx.globalAlpha = this.alpha
        ctx.fill()

        // 光を追加
        const gradient = ctx.createRadialGradient(
          this.x,
          this.y,
          0,
          this.x,
          this.y,
          this.size * 3
        )
        gradient.addColorStop(0, this.color)
        gradient.addColorStop(1, "transparent")
        ctx.fillStyle = gradient
        ctx.globalAlpha = this.alpha * 0.3
        ctx.fill()

        ctx.globalAlpha = 1
      }

      isDead() {
        return this.alpha <= 0
      }
    }

    // ロケット（打ち上げ）クラス
    class Rocket {
      constructor(x, targetY) {
        this.x = x
        this.y = canvas.height
        this.targetY = targetY
        this.vy = -8 // 上向きの速度
        this.exploded = false
        this.color = "#ffffff"

        // 爆発時の色パレット
        this.palette =
          colorPalettes[Math.floor(Math.random() * colorPalettes.length)]
      }

      update() {
        this.y += this.vy

        // 目標地点に達したら爆発
        if (this.y <= this.targetY) {
          this.explode()
        }
      }

      draw() {
        // ロケット本体
        ctx.beginPath()
        ctx.arc(this.x, this.y, 2, 0, Math.PI * 2)
        ctx.fillStyle = this.color
        ctx.fill()

        // ロケットの軌跡
        ctx.beginPath()
        ctx.moveTo(this.x, this.y)
        ctx.lineTo(this.x, this.y + 10)
        ctx.strokeStyle = "rgba(255, 255, 255, 0.5)"
        ctx.lineWidth = 1
        ctx.stroke()
      }

      explode() {
        this.exploded = true

        // パーティクルを生成
        const particleCount = 100 + Math.random() * 50
        console.log(particleCount)

        for (let i = 0; i < particleCount; i++) {
          const color =
            this.palette[Math.floor(Math.random() * this.palette.length)]
          particles.push(new Particle(this.x, this.y, color))
        }

        // 音を追加したい場合はここに
        // new Audio('explosion.mp3').play();
      }
    }

    // クリックで花火を打ち上げ
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect()
      const x = e.clientX - rect.left
      const targetY = e.clientY - rect.top
      launchRocket(x, targetY)
    })

    // ロケット発射関数
    function launchRocket(x, targetY) {
      rockets.push(new Rocket(x, targetY))
    }

    // 自動打ち上げの切り替え
    const toggleBtn = document.getElementById("toggleAuto")
    const autoStatus = document.getElementById("autoStatus")

    toggleBtn.addEventListener("click", () => {
      autoLaunch = !autoLaunch
      autoStatus.textContent = autoLaunch ? "ON" : "OFF"
    })

    // ランダム打ち上げ
    let autoLaunchTimer = 0
    function randomLaunch() {
      if (autoLaunch) {
        autoLaunchTimer++
        if (autoLaunchTimer > 60) {
          // 約1秒ごと
          const x = Math.random() * canvas.width
          const targetY = Math.random() * canvas.height * 0.5 + 50
          launchRocket(x, targetY)
          autoLaunchTimer = 0
        }
      }
    }

    // メインアニメーション
    function animate() {
      // 画面を少し透明な黒で塗りつぶす（軌跡効果）
      ctx.fillStyle = "rgba(0, 4, 40, 0.15)"
      ctx.fillRect(0, 0, canvas.width, canvas.height)

      // ロケットの更新と描画
      for (let i = rockets.length - 1; i >= 0; i--) {
        rockets[i].update()
        rockets[i].draw()

        if (rockets[i].exploded) {
          rockets.splice(i, 1)
        }
      }

      // パーティクルの更新と描画
      for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update()
        particles[i].draw()

        if (particles[i].isDead()) {
          particles.splice(i, 1)
        }
      }

      // 自動打ち上げ
      randomLaunch()

      requestAnimationFrame(animate)
      // setInterval(animate, 3000)
    }

    // アニメーション開始
    animate()
  </script>
</body>

</html>
